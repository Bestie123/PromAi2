<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Варианты смещения стрелок</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: Arial, sans-serif;
            background: #0d1117; 
            color: #c9d1d9; 
            padding: 20px;
        }
        
        .variant {
            margin-bottom: 40px;
            border: 2px solid #30363d;
            border-radius: 8px;
            padding: 20px;
            background: #161b22;
        }
        
        h2 {
            color: #58a6ff;
            margin-bottom: 15px;
        }
        
        .canvas {
            position: relative;
            width: 800px;
            height: 400px;
            background: #0d1117;
            border: 1px solid #30363d;
        }
        
        .node {
            position: absolute;
            background: #21262d;
            border: 2px solid #58a6ff;
            border-radius: 8px;
            padding: 10px;
            width: 150px;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .connection {
            position: absolute;
            height: 3px;
            background: #f79009;
            transform-origin: left center;
        }
        
        .arrow {
            position: absolute;
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-top: 10px solid #f79009;
            right: -6px;
            top: 50%;
            transform: translateY(-50%);
        }
    </style>
</head>
<body>
    <h1>Варианты смещения стрелок относительно границ нод</h1>
    
    <!-- Вариант A -->
    <div class="variant">
        <h2>Вариант A: Точно на границе (offset = 0)</h2>
        <p>Стрелка начинается и заканчивается ровно на границе ноды</p>
        <div class="canvas" id="canvas-a"></div>
    </div>
    
    <!-- Вариант B -->
    <div class="variant">
        <h2>Вариант B: Небольшой отступ (offset = 5px)</h2>
        <p>Стрелка начинается на 5px за границей и заканчивается на 5px перед границей</p>
        <div class="canvas" id="canvas-b"></div>
    </div>
    
    <!-- Вариант C -->
    <div class="variant">
        <h2>Вариант C: Средний отступ (offset = 10px)</h2>
        <p>Стрелка начинается на 10px за границей и заканчивается на 10px перед границей</p>
        <div class="canvas" id="canvas-c"></div>
    </div>
    
    <!-- Вариант D -->
    <div class="variant">
        <h2>Вариант D: Большой отступ (offset = 15px)</h2>
        <p>Стрелка начинается на 15px за границей и заканчивается на 15px перед границей</p>
        <div class="canvas" id="canvas-d"></div>
    </div>
    
    <!-- Вариант E -->
    <div class="variant">
        <h2>Вариант E: Асимметричный (выход +10px, вход -5px)</h2>
        <p>Стрелка начинается на 10px за границей, заканчивается на 5px перед границей</p>
        <div class="canvas" id="canvas-e"></div>
    </div>
    
    <!-- Вариант F -->
    <div class="variant">
        <h2>Вариант F: Внутрь нод (offset = -5px)</h2>
        <p>Стрелка начинается на 5px внутри исходной ноды и заканчивается на 5px внутри целевой</p>
        <div class="canvas" id="canvas-f"></div>
    </div>

    <script>
        // Тестовые ноды
        const nodes = [
            { x: 50, y: 50, label: 'Нода 1' },
            { x: 400, y: 150, label: 'Нода 2' },
            { x: 600, y: 50, label: 'Нода 3' },
            { x: 200, y: 250, label: 'Нода 4' }
        ];
        
        const nodeWidth = 150;
        const nodeHeight = 80;
        
        // Создаем ноды для всех вариантов
        ['a', 'b', 'c', 'd', 'e', 'f'].forEach(variant => {
            const canvas = document.getElementById(`canvas-${variant}`);
            nodes.forEach(node => {
                const div = document.createElement('div');
                div.className = 'node';
                div.style.left = node.x + 'px';
                div.style.top = node.y + 'px';
                div.textContent = node.label;
                canvas.appendChild(div);
            });
        });
        
        // Рисуем стрелки между нодами
        const connections = [
            [0, 1], // Нода 1 -> Нода 2
            [1, 2], // Нода 2 -> Нода 3
            [0, 3], // Нода 1 -> Нода 4
            [3, 1]  // Нода 4 -> Нода 2
        ];
        
        // Конфигурация смещений для каждого варианта
        const offsets = {
            'a': { from: 0, to: 0 },      // Точно на границе
            'b': { from: 5, to: -5 },     // Небольшой отступ
            'c': { from: 10, to: -10 },   // Средний отступ
            'd': { from: 15, to: -15 },   // Большой отступ
            'e': { from: 10, to: -5 },    // Асимметричный
            'f': { from: -5, to: 5 }      // Внутрь нод
        };
        
        // Рисуем для всех вариантов
        ['a', 'b', 'c', 'd', 'e', 'f'].forEach(variant => {
            connections.forEach(([fromIdx, toIdx]) => {
                const from = nodes[fromIdx];
                const to = nodes[toIdx];
                createConnection(`canvas-${variant}`, from, to, offsets[variant]);
            });
        });
        
        // Математический расчет пересечения с учетом смещения
        function createConnection(canvasId, from, to, offset) {
            const canvas = document.getElementById(canvasId);
            
            const fromCenterX = from.x + nodeWidth / 2;
            const fromCenterY = from.y + nodeHeight / 2;
            const toCenterX = to.x + nodeWidth / 2;
            const toCenterY = to.y + nodeHeight / 2;
            
            // Вычисляем пересечение луча с границами
            const fromIntersect = getRectIntersection(
                fromCenterX, fromCenterY,
                toCenterX, toCenterY,
                from.x, from.y, nodeWidth, nodeHeight
            );
            
            const toIntersect = getRectIntersection(
                toCenterX, toCenterY,
                fromCenterX, fromCenterY,
                to.x, to.y, nodeWidth, nodeHeight
            );
            
            // Применяем смещение
            const dx = toCenterX - fromCenterX;
            const dy = toCenterY - fromCenterY;
            const distance = Math.sqrt(dx * dx + dy * dy);
            const dirX = dx / distance;
            const dirY = dy / distance;
            
            // Смещаем точки
            const fromX = fromIntersect.x + dirX * offset.from;
            const fromY = fromIntersect.y + dirY * offset.from;
            const toX = toIntersect.x - dirX * offset.to;
            const toY = toIntersect.y - dirY * offset.to;
            
            drawLine(canvas, fromX, fromY, toX, toY);
        }
        
        function getRectIntersection(cx, cy, tx, ty, rx, ry, rw, rh) {
            const dx = tx - cx;
            const dy = ty - cy;
            
            let minT = Infinity;
            let resultX = cx;
            let resultY = cy;
            
            // Правая граница
            if (dx !== 0) {
                const t = (rx + rw - cx) / dx;
                const y = cy + dy * t;
                if (t > 0 && t < minT && y >= ry && y <= ry + rh) {
                    minT = t;
                    resultX = rx + rw;
                    resultY = y;
                }
            }
            
            // Левая граница
            if (dx !== 0) {
                const t = (rx - cx) / dx;
                const y = cy + dy * t;
                if (t > 0 && t < minT && y >= ry && y <= ry + rh) {
                    minT = t;
                    resultX = rx;
                    resultY = y;
                }
            }
            
            // Нижняя граница
            if (dy !== 0) {
                const t = (ry + rh - cy) / dy;
                const x = cx + dx * t;
                if (t > 0 && t < minT && x >= rx && x <= rx + rw) {
                    minT = t;
                    resultX = x;
                    resultY = ry + rh;
                }
            }
            
            // Верхняя граница
            if (dy !== 0) {
                const t = (ry - cy) / dy;
                const x = cx + dx * t;
                if (t > 0 && t < minT && x >= rx && x <= rx + rw) {
                    minT = t;
                    resultX = x;
                    resultY = ry;
                }
            }
            
            return { x: resultX, y: resultY };
        }
        
        // Вспомогательная функция для рисования линии
        function drawLine(canvas, fromX, fromY, toX, toY) {
            const line = document.createElement('div');
            line.className = 'connection';
            
            const dx = toX - fromX;
            const dy = toY - fromY;
            const length = Math.sqrt(dx * dx + dy * dy);
            const angle = Math.atan2(dy, dx) * 180 / Math.PI;
            
            line.style.left = fromX + 'px';
            line.style.top = fromY + 'px';
            line.style.width = length + 'px';
            line.style.transform = `rotate(${angle}deg)`;
            
            const arrow = document.createElement('div');
            arrow.className = 'arrow';
            line.appendChild(arrow);
            
            canvas.appendChild(line);
        }
    </script>
</body>
</html>
