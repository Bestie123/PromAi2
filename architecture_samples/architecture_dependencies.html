<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PromAi PKM - –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ –ø–æ—Ä—è–¥–æ–∫ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0d1117; color: #c9d1d9; overflow: hidden;
        }
        #canvas { 
            width: 15000px; height: 10000px; position: relative; 
            background: radial-gradient(circle at 50% 50%, #161b22 0%, #0d1117 100%);
            transform-origin: 0 0;
        }
        #viewport { 
            width: 100vw; height: 100vh; overflow: hidden; position: relative;
            cursor: grab; background: #0d1117;
        }
        #viewport.dragging { cursor: grabbing; }
        
        .node {
            position: absolute; background: #21262d; border: 2px solid #30363d;
            border-radius: 12px; padding: 16px; min-width: 280px; max-width: 320px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.4); transition: all 0.3s ease;
        }
        .node:hover { transform: scale(1.05); box-shadow: 0 12px 48px rgba(0,0,0,0.6); }
        
        .critical { border-color: #f85149; background: linear-gradient(135deg, #21262d 0%, #2d1b1f 100%); }
        .important { border-color: #f79009; background: linear-gradient(135deg, #21262d 0%, #2d2419 100%); }
        .flexible { border-color: #3fb950; background: linear-gradient(135deg, #21262d 0%, #1b2d1f 100%); }
        .question { border-color: #58a6ff; background: linear-gradient(135deg, #21262d 0%, #1b2332 100%); }
        .rejected { border-color: #8b949e; background: linear-gradient(135deg, #21262d 0%, #2d2d2d 100%); opacity: 0.7; }
        
        .phase-foundation { border-left: 5px solid #f85149; }
        .phase-core { border-left: 5px solid #f79009; }
        .phase-features { border-left: 5px solid #3fb950; }
        .phase-polish { border-left: 5px solid #58a6ff; }
        
        .badge {
            display: inline-block; padding: 4px 8px; border-radius: 6px; font-size: 11px;
            font-weight: bold; margin-bottom: 8px;
        }
        .badge.critical { background: #f85149; color: #fff; }
        .badge.important { background: #f79009; color: #fff; }
        .badge.flexible { background: #3fb950; color: #fff; }
        .badge.question { background: #58a6ff; color: #fff; }
        .badge.rejected { background: #8b949e; color: #fff; }
        
        .development-order {
            position: absolute; top: -10px; right: -10px;
            background: #238636; color: #fff; border-radius: 50%;
            width: 24px; height: 24px; display: flex; align-items: center; justify-content: center;
            font-size: 12px; font-weight: bold;
        }
        
        .node h3 { font-size: 14px; margin-bottom: 8px; color: #f0f6fc; }
        .node p { font-size: 12px; line-height: 1.4; margin-bottom: 8px; color: #8b949e; }
        .details { font-size: 11px; color: #6e7681; }
        .meta { font-size: 10px; color: #6e7681; margin-top: 8px; }
        
        .connection {
            position: absolute; height: 3px; transform-origin: left center;
            z-index: 1;
        }
        .connection.dependency { background: #f85149; }
        .connection.enables { background: #3fb950; }
        .connection.blocks { background: #f79009; }
        .connection.enhances { background: #58a6ff; opacity: 0.6; }
        
        .dependency-arrow {
            position: absolute; right: -8px; top: -4px;
            width: 0; height: 0;
            border-left: 8px solid;
            border-top: 4px solid transparent;
            border-bottom: 4px solid transparent;
        }
        .dependency-arrow.dependency { border-left-color: #f85149; }
        .dependency-arrow.enables { border-left-color: #3fb950; }
        .dependency-arrow.blocks { border-left-color: #f79009; }
        .dependency-arrow.enhances { border-left-color: #58a6ff; }
        
        .phase-separator {
            position: absolute; width: 2px; height: 100%;
            background: linear-gradient(to bottom, transparent 0%, #30363d 20%, #30363d 80%, transparent 100%);
            z-index: -1;
        }
        
        .phase-label {
            position: absolute; top: 50px; left: -80px;
            transform: rotate(-90deg); transform-origin: center;
            font-size: 14px; font-weight: bold; color: #8b949e;
            white-space: nowrap;
        }
        
        .controls {
            position: fixed; top: 20px; left: 20px; z-index: 1000;
            background: rgba(33, 38, 45, 0.9); padding: 12px; border-radius: 8px;
            border: 1px solid #30363d;
        }
        .controls button {
            background: #238636; color: #fff; border: none; padding: 8px 12px;
            border-radius: 6px; margin-right: 8px; cursor: pointer; font-size: 12px;
        }
        .controls button:hover { background: #2ea043; }
        .controls button.active { background: #f79009; }
        
        .legend {
            position: fixed; top: 20px; right: 20px; z-index: 1000;
            background: rgba(33, 38, 45, 0.9); padding: 12px; border-radius: 8px;
            border: 1px solid #30363d; font-size: 12px;
        }
        .legend-item {
            display: flex; align-items: center; margin-bottom: 6px;
        }
        .legend-color {
            width: 16px; height: 3px; margin-right: 8px; border-radius: 2px;
        }
        
        .zoom-info {
            position: fixed; bottom: 20px; right: 20px; z-index: 1000;
            background: rgba(33, 38, 45, 0.9); padding: 8px 12px; border-radius: 6px;
            border: 1px solid #30363d; font-size: 12px;
        }
        
        .stats {
            position: fixed; bottom: 20px; left: 20px; z-index: 1000;
            background: rgba(33, 38, 45, 0.9); padding: 8px 12px; border-radius: 6px;
            border: 1px solid #30363d; font-size: 12px; color: #3fb950;
        }
        
        .timeline {
            position: fixed; bottom: 80px; left: 20px; z-index: 1000;
            background: rgba(33, 38, 45, 0.9); padding: 12px; border-radius: 8px;
            border: 1px solid #30363d; font-size: 12px; max-width: 300px;
        }
        .timeline h4 { color: #f0f6fc; margin-bottom: 8px; }
        .timeline-phase {
            display: flex; justify-content: space-between; margin-bottom: 4px;
            padding: 4px 8px; border-radius: 4px;
        }
        .timeline-phase.foundation { background: rgba(248, 81, 73, 0.2); }
        .timeline-phase.core { background: rgba(247, 144, 9, 0.2); }
        .timeline-phase.features { background: rgba(63, 185, 80, 0.2); }
        .timeline-phase.polish { background: rgba(88, 166, 255, 0.2); }
    </style>
</head>
<body>
    <div class="controls">
        <button onclick="resetView()">–°–±—Ä–æ—Å</button>
        <button onclick="centerView()">–¶–µ–Ω—Ç—Ä</button>
        <button id="showDeps" onclick="toggleDependencies()">–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏</button>
        <button id="showPhases" onclick="togglePhases()">–§–∞–∑—ã</button>
        <span style="color: #8b949e; margin-left: 12px;">–ö–æ–ª–µ—Å–æ –º—ã—à–∏ - –∑—É–º | –õ–ö–ú - –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ</span>
    </div>
    
    <div class="legend">
        <h4 style="color: #f0f6fc; margin-bottom: 8px;">–°–≤—è–∑–∏:</h4>
        <div class="legend-item">
            <div class="legend-color" style="background: #f85149;"></div>
            <span>–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å (–±–ª–æ–∫–∏—Ä—É–µ—Ç)</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #3fb950;"></div>
            <span>–í–∫–ª—é—á–∞–µ—Ç (enables)</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #f79009;"></div>
            <span>–ë–ª–æ–∫–∏—Ä—É–µ—Ç —Ä–∞–∑–≤–∏—Ç–∏–µ</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #58a6ff;"></div>
            <span>–£–ª—É—á—à–∞–µ—Ç (enhances)</span>
        </div>
    </div>
    
    <div class="timeline">
        <h4>–ü–ª–∞–Ω —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏:</h4>
        <div class="timeline-phase foundation">
            <span>–§–∞–∑–∞ 1: –§—É–Ω–¥–∞–º–µ–Ω—Ç</span>
            <span>4 –Ω–µ–¥–µ–ª–∏</span>
        </div>
        <div class="timeline-phase core">
            <span>–§–∞–∑–∞ 2: –Ø–¥—Ä–æ</span>
            <span>6 –Ω–µ–¥–µ–ª—å</span>
        </div>
        <div class="timeline-phase features">
            <span>–§–∞–∑–∞ 3: –§—É–Ω–∫—Ü–∏–∏</span>
            <span>8 –Ω–µ–¥–µ–ª—å</span>
        </div>
        <div class="timeline-phase polish">
            <span>–§–∞–∑–∞ 4: –î–æ–≤–æ–¥–∫–∞</span>
            <span>10 –Ω–µ–¥–µ–ª—å</span>
        </div>
    </div>
    
    <div class="zoom-info">
        –ó—É–º: <span id="zoomLevel">100%</span>
    </div>
    
    <div class="stats">
        –£–∑–ª–æ–≤: <span id="nodeCount">0</span> | –ö—Ä–∏—Ç–µ—Ä–∏–µ–≤: <span id="criteriaCount">29/29</span> ‚úÖ
    </div>
    
    <div id="viewport">
        <div id="canvas"></div>
    </div>

    <script>
        let nodes = [];
        let dependencies = {};
        let phases = {};
        let scale = 0.15;
        let translateX = 100;
        let translateY = 50;
        let isDragging = false;
        let lastMouseX = 0;
        let lastMouseY = 0;
        let showDependencies = true;
        let showPhases = true;

        // Load enhanced nodes
        fetch('./nodes_enhanced.json')
            .then(response => response.json())
            .then(data => {
                nodes = Object.values(data.nodes);
                dependencies = data.dependencies;
                phases = data.development_phases;
                initCanvas();
                updateTransform();
            })
            .catch(error => {
                console.error('Failed to load nodes:', error);
                // Fallback data
                nodes = [
                    { id: 'q1', x: 500, y: 100, type: 'question', title: '‚ùì –ú–æ–¥—É–ª—å–Ω–æ—Å—Ç—å –¥–≤–∏–∂–∫–∞?', phase: 'foundation' },
                    { id: 'modular-arch', x: 200, y: 300, type: 'critical', title: '‚úÖ –ú–æ–¥—É–ª—å–Ω–∞—è', phase: 'foundation', developmentOrder: 1 }
                ];
                initCanvas();
                updateTransform();
            });

        function createNode(node) {
            const div = document.createElement('div');
            div.className = `node ${node.type}`;
            if (node.phase) div.classList.add(`phase-${node.phase}`);
            
            div.style.left = node.x + 'px';
            div.style.top = node.y + 'px';
            
            const badge = node.type === 'critical' ? '–ö–†–ò–¢–ò–ß–ù–û' : 
                         node.type === 'important' ? '–í–ê–ñ–ù–û' : 
                         node.type === 'flexible' ? '–ì–ò–ë–ö–û' :
                         node.type === 'question' ? '–í–û–ü–†–û–°' : '–û–¢–ö–õ–û–ù–ï–ù–û';
            
            let metaInfo = '';
            if (node.estimatedWeeks) metaInfo += `‚è±Ô∏è ${node.estimatedWeeks}–Ω `;
            if (node.dependsOn) metaInfo += `üîó –ó–∞–≤–∏—Å–∏—Ç –æ—Ç: ${node.dependsOn.join(', ')} `;
            if (node.enables) metaInfo += `‚úÖ –í–∫–ª—é—á–∞–µ—Ç: ${node.enables.slice(0,2).join(', ')}${node.enables.length > 2 ? '...' : ''} `;
            
            div.innerHTML = `
                <div class="badge ${node.type}">${badge}</div>
                <h3>${node.title}</h3>
                <p>${node.description}</p>
                <div class="details">${node.details}</div>
                ${metaInfo ? `<div class="meta">${metaInfo}</div>` : ''}
            `;
            
            if (node.developmentOrder) {
                const orderBadge = document.createElement('div');
                orderBadge.className = 'development-order';
                orderBadge.textContent = node.developmentOrder;
                div.appendChild(orderBadge);
            }
            
            return div;
        }

        function createConnection(from, to, type, label = '') {
            const line = document.createElement('div');
            line.className = `connection ${type}`;
            
            const dx = to.x - from.x;
            const dy = to.y - from.y;
            const length = Math.sqrt(dx * dx + dy * dy);
            const angle = Math.atan2(dy, dx) * 180 / Math.PI;
            
            line.style.left = (from.x + 160) + 'px';
            line.style.top = (from.y + 60) + 'px';
            line.style.width = length + 'px';
            line.style.transform = `rotate(${angle}deg)`;
            
            // Add arrow
            const arrow = document.createElement('div');
            arrow.className = `dependency-arrow ${type}`;
            line.appendChild(arrow);
            
            // Add label if provided
            if (label) {
                const labelEl = document.createElement('div');
                labelEl.style.position = 'absolute';
                labelEl.style.left = (length / 2 - 20) + 'px';
                labelEl.style.top = '-15px';
                labelEl.style.fontSize = '10px';
                labelEl.style.color = '#8b949e';
                labelEl.style.background = '#0d1117';
                labelEl.style.padding = '2px 4px';
                labelEl.style.borderRadius = '3px';
                labelEl.textContent = label;
                line.appendChild(labelEl);
            }
            
            return line;
        }

        function createPhaseSeparator(x, phase) {
            const separator = document.createElement('div');
            separator.className = 'phase-separator';
            separator.style.left = x + 'px';
            separator.style.top = '0px';
            
            const label = document.createElement('div');
            label.className = 'phase-label';
            label.textContent = `–§–ê–ó–ê ${phase.priority}: ${phase.description.toUpperCase()}`;
            separator.appendChild(label);
            
            return separator;
        }

        function initCanvas() {
            const canvas = document.getElementById('canvas');
            canvas.innerHTML = '';
            const nodeMap = {};
            
            // Create phase separators
            if (showPhases) {
                const phasePositions = { foundation: 1000, core: 3000, features: 5000, polish: 7000 };
                Object.keys(phases).forEach(phaseKey => {
                    const phase = phases[phaseKey];
                    const x = phasePositions[phaseKey.split('_')[1]] || 1000;
                    const separator = createPhaseSeparator(x, phase);
                    canvas.appendChild(separator);
                });
            }
            
            // Create nodes
            nodes.forEach(node => {
                const nodeEl = createNode(node);
                canvas.appendChild(nodeEl);
                nodeMap[node.id] = node;
            });
            
            // Create dependency connections
            if (showDependencies && dependencies) {
                // Hard dependencies
                if (dependencies.hard) {
                    Object.keys(dependencies.hard).forEach(criteriaId => {
                        const dep = dependencies.hard[criteriaId];
                        const sourceNode = nodes.find(n => n.criteriaId == criteriaId && n.type === 'critical');
                        
                        if (sourceNode && dep.enables) {
                            dep.enables.forEach(targetCriteriaId => {
                                const targetNode = nodes.find(n => n.criteriaId == targetCriteriaId && n.type === 'critical');
                                if (targetNode) {
                                    const connection = createConnection(sourceNode, targetNode, 'enables', 'enables');
                                    canvas.appendChild(connection);
                                }
                            });
                        }
                    });
                }
                
                // Development order dependencies
                nodes.forEach(node => {
                    if (node.dependsOn) {
                        node.dependsOn.forEach(depId => {
                            const depNode = nodeMap[depId];
                            if (depNode) {
                                const connection = createConnection(depNode, node, 'dependency', 'blocks');
                                canvas.appendChild(connection);
                            }
                        });
                    }
                    
                    if (node.blocks) {
                        node.blocks.forEach(blockId => {
                            const blockNode = nodeMap[blockId];
                            if (blockNode) {
                                const connection = createConnection(node, blockNode, 'blocks', 'blocks');
                                canvas.appendChild(connection);
                            }
                        });
                    }
                });
            }
            
            // Original children connections
            nodes.forEach(node => {
                if (node.children) {
                    node.children.forEach(childId => {
                        const child = nodeMap[childId];
                        if (child) {
                            const connection = createConnection(node, child, node.type);
                            canvas.appendChild(connection);
                        }
                    });
                }
            });
            
            document.getElementById('nodeCount').textContent = nodes.length;
        }

        function toggleDependencies() {
            showDependencies = !showDependencies;
            document.getElementById('showDeps').classList.toggle('active', showDependencies);
            initCanvas();
        }

        function togglePhases() {
            showPhases = !showPhases;
            document.getElementById('showPhases').classList.toggle('active', showPhases);
            initCanvas();
        }

        function updateTransform() {
            const canvas = document.getElementById('canvas');
            canvas.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`;
            document.getElementById('zoomLevel').textContent = Math.round(scale * 100) + '%';
        }

        function resetView() {
            scale = 0.15;
            translateX = 100;
            translateY = 50;
            updateTransform();
        }

        function centerView() {
            translateX = 100;
            translateY = 50;
            updateTransform();
        }

        // Event listeners
        const viewport = document.getElementById('viewport');

        viewport.addEventListener('wheel', (e) => {
            e.preventDefault();
            
            const rect = viewport.getBoundingClientRect();
            const mouseX = e.clientX - rect.left;
            const mouseY = e.clientY - rect.top;
            
            const delta = e.deltaY > 0 ? 0.9 : 1.1;
            const newScale = Math.max(0.05, Math.min(3, scale * delta));
            
            const canvasX = (mouseX - translateX) / scale;
            const canvasY = (mouseY - translateY) / scale;
            
            scale = newScale;
            
            translateX = mouseX - canvasX * scale;
            translateY = mouseY - canvasY * scale;
            
            updateTransform();
        });

        viewport.addEventListener('mousedown', (e) => {
            if (e.button === 0) {
                isDragging = true;
                lastMouseX = e.clientX;
                lastMouseY = e.clientY;
                viewport.classList.add('dragging');
            }
        });

        document.addEventListener('mousemove', (e) => {
            if (isDragging) {
                const deltaX = e.clientX - lastMouseX;
                const deltaY = e.clientY - lastMouseY;
                translateX += deltaX;
                translateY += deltaY;
                lastMouseX = e.clientX;
                lastMouseY = e.clientY;
                updateTransform();
            }
        });

        document.addEventListener('mouseup', () => {
            isDragging = false;
            viewport.classList.remove('dragging');
        });

        // Initialize
        document.getElementById('showDeps').classList.add('active');
        document.getElementById('showPhases').classList.add('active');
    </script>
</body>
</html>